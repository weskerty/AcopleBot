import TelegramBot from"node-telegram-bot-api";import redis from"redis";import crypto from"crypto";import fs from"fs";import path from"path";import https from"https";import http from"http";const ENV=process.env,LOAD_TELEGRAM_TOKENS=()=>{const e=[];let t=1;for(;ENV[`TELEGRAM_T${t}`];)e.push({token:ENV[`TELEGRAM_T${t}`],id:`telegram-${t}`,targetChatId:ENV[`TARGET_CHAT_ID_${t}`]||ENV.TARGET_CHAT_ID}),t++;return 0===e.length&&(console.error("No se encontraron tokens. Corrige el ENV"),process.exit(1)),console.log(`Encontrados ${e.length}`),e},LOAD_RULES=()=>{const e=[];let t=1;for(;ENV[`REGLA_${t}`];){const n=ENV[`REGLA_${t}`];console.log(`Cargando REGLA_${t}: ${n}`);const a={ruleId:`REGLA_${t}`,targets:[],isAll:!1},o=n.split(",");for(const e of o){const t=e.trim();if(t.startsWith("all:")){a.isAll=!0;const[,e,n,o]=t.split(":");a.targets.push({adapterId:e.trim(),chatId:n.trim(),direction:o.trim()})}else{const e=t.split(":");if(e.length>=3){const t=e[0].trim(),n=e[1].trim(),o=e[2].trim();let r=n,i=null;n.includes("/")&&([r,i]=n.split("/")),a.targets.push({adapterId:t,chatId:r,threadId:i||null,direction:o})}}}e.push(a),t++}return console.log(`Cargadas ${e.length} reglas:`),e.forEach((e=>{console.log(`  ${e.ruleId} (all: ${e.isAll}):`,e.targets)})),e},TELEGRAM_CONFIGS=LOAD_TELEGRAM_TOKENS(),ROUTING_RULES=LOAD_RULES(),VALKEY_HOST=ENV.VALKEY_HOST,VALKEY_PORT=Number(ENV.VALKEY_PORT),MEDIA_FOLDER=ENV.MEDIA_FOLDER||"../media",C={PLATFORM:"telegram",CHANNEL:"bot.On.AdaptadorMessage",HISTORY_KEY:"history:global",INDEX_UNIVERSAL:"index:universal:",INDEX_PLATFORM:"index:platform:telegram:",SEARCH_LIMIT:1e3,TEXT_LIMIT:100,UUID_LENGTH:8,EVENTS:{MESSAGE:"message",EDIT:"edit",DELETE:"delete",PIN:"pin",JOIN:"join",LEAVE:"leave",BAN:"ban",API:"api",REACTION:"reaction"},MEDIA:{IMAGE:"image",VIDEO:"video",AUDIO:"audio",VOICE:"voice",DOCUMENT:"document",STICKER:"sticker",GIF:"gif",VIDEO_NOTE:"video_note"},ERRORS:{REDIS:"Redis Error:",DOWNLOAD:"Error downloading file:",SEND:"Error enviando archivo:",PROCESS:"Error procesando evento",SUBSCRIBE:"Error procesando mensaje de suscripcion:",INDEX:"Error creating message index:",FIND:"Error finding message by universalId:"},MESSAGES:{CONNECTED:"Conectado a Valkey exitosamente",CONNECTION_ERROR:"Error conectando a Valkey:",DOWNLOAD_SUCCESS:"Archivo descargado:",MEDIA_NOT_FOUND:"Media no encontrada:",MEDIA_ERROR:"Error enviando"}},REDIS_CONFIG={socket:{host:VALKEY_HOST,port:VALKEY_PORT}},botInstances=[];let publisherClient,indexClient,subscriberClient;const INIT_CLIENTS=async()=>{publisherClient=redis.createClient(REDIS_CONFIG),indexClient=redis.createClient(REDIS_CONFIG),subscriberClient=redis.createClient(REDIS_CONFIG),[publisherClient,indexClient,subscriberClient].forEach((e=>{e.on("error",(e=>console.error(C.ERRORS.REDIS,e)))}));try{await Promise.all([publisherClient.connect(),indexClient.connect(),subscriberClient.connect()]),console.log(C.MESSAGES.CONNECTED),await SETUP_GLOBAL_SUBSCRIBER(subscriberClient)}catch(e){console.error(C.MESSAGES.CONNECTION_ERROR,e),process.exit(1)}for(const e of TELEGRAM_CONFIGS)try{const t=new TelegramBot(e.token,{polling:!0}),n=await t.getMe(),a={bot:t,config:e,info:n};botInstances.push(a),console.log(`Bot ${n.username} (${e.id}) inicializado`),SETUP_EVENT_HANDLERS(a)}catch(t){console.error(`Error inicializando bot ${e.id}:`,t)}0===botInstances.length&&(console.error("No se pudo inicializar ningun bot"),process.exit(1))},GENERATE_FILE_NAME=(e,t)=>`${e}_${Date.now()}_${crypto.randomUUID().substring(0,C.UUID_LENGTH)}${t}`,DOWNLOAD_FILE=async(e,t,n)=>{try{const a=await e.getFile(t),o=`https://api.telegram.org/file/bot${e.token}/${a.file_path}`,r=path.join(MEDIA_FOLDER,n);return new Promise(((t,a)=>{const i=fs.createWriteStream(r);(o.startsWith("https")?https:http).get(o,(o=>{if(o.statusCode>=300&&o.statusCode<400&&o.headers.location)return DOWNLOAD_FILE(e,o.headers.location,n).then(t).catch(a);200===o.statusCode?(o.pipe(i),i.on("finish",(()=>{i.close(),t(r)})),i.on("error",a)):a(new Error(`HTTP ${o.statusCode}: ${o.statusMessage}`))})).on("error",(e=>{fs.unlink(r,(()=>{})),a(e)}))}))}catch(e){throw console.error(C.ERRORS.DOWNLOAD,e),e}},CREATE_MESSAGE_INDEX=async(e,t)=>{try{const n=C.INDEX_UNIVERSAL+e;if(await indexClient.hSet(n,{universalId:e,platform:t.platform,adapterId:t.adapterId,messageId:t.message?.id||"",chatId:t.conversation.id,authorId:t.author.id,timestamp:t.timestamp.toString(),text:t.message?.text||""}),t.message?.id){const n=`${C.INDEX_PLATFORM}${t.adapterId}:${t.message.id}`;await indexClient.set(n,e)}}catch(e){console.error(C.ERRORS.INDEX,e)}},FIND_MESSAGE_BY_UNIVERSAL_ID=async e=>{try{const t=C.INDEX_UNIVERSAL+e,n=await indexClient.hGetAll(t);return Object.keys(n).length>0?n:null}catch(e){return console.error(C.ERRORS.FIND,e),null}},FIND_ORIGINAL_MESSAGE=async(e,t)=>{try{const n=`${C.INDEX_PLATFORM}${t}:${e}`;let a=await indexClient.get(n);if(a)return await FIND_MESSAGE_BY_UNIVERSAL_ID(a);for(const t of botInstances){const n=`${C.INDEX_PLATFORM}${t.config.id}:${e}`;if(a=await indexClient.get(n),a)return await FIND_MESSAGE_BY_UNIVERSAL_ID(a)}const o=await indexClient.lLen(C.HISTORY_KEY),r=Math.min(o,C.SEARCH_LIMIT);for(let t=0;t<r;t++){const n=await indexClient.lIndex(C.HISTORY_KEY,-1-t);if(n)try{const t=JSON.parse(n);if(t.platform===C.PLATFORM&&t.message?.id===e)return t}catch(e){continue}}return null}catch(e){return console.error("Error finding original message:",e),null}},GET_MEDIA_INFO=e=>{const t=[{key:"photo",type:C.MEDIA.IMAGE,mime:"image/jpeg",ext:".jpg",getFile:e=>e[e.length-1]},{key:"video",type:C.MEDIA.VIDEO,mime:"video/mp4",ext:".mp4"},{key:"video_note",type:C.MEDIA.VIDEO_NOTE,mime:"video/mp4",ext:".mp4"},{key:"document",type:C.MEDIA.DOCUMENT,mime:"application/octet-stream",ext:"",getFile:e=>e},{key:"audio",type:C.MEDIA.AUDIO,mime:"audio/mpeg",ext:".mp3"},{key:"voice",type:C.MEDIA.VOICE,mime:"audio/ogg",ext:".ogg"},{key:"sticker",type:C.MEDIA.STICKER,mime:"image/webp",ext:".webp"},{key:"animation",type:C.MEDIA.GIF,mime:"video/mp4",ext:".mp4"}];for(const n of t)if(e[n.key]){const t=n.getFile?n.getFile(e[n.key]):e[n.key],a="document"===n.key&&t.file_name?path.extname(t.file_name):n.ext;return{fileId:t.file_id,type:n.type,mimeType:t.mime_type||n.mime,fileName:t.file_name||GENERATE_FILE_NAME(n.type,a),width:t.width||null,height:t.height||null,duration:t.duration||null}}return null},CREATE_BASE_MESSAGE=(e,t,n,a={})=>{const o=e.message||e.edited_message||e.channel_post||e.edited_channel_post||e;return{universalId:crypto.randomUUID(),timestamp:Date.now(),platform:C.PLATFORM,adapterId:n,eventType:t,server:{id:null,name:null},conversation:{id:o.chat?o.chat.id.toString():e.chat_id||"unknown",name:o.chat&&(o.chat.title||o.chat.first_name||o.chat.username)||"Unknown",type:o.chat?"private"===o.chat.type?"dm":o.chat.type:"unknown"},thread:{id:null,name:null},author:{id:o.from?o.from.id.toString():e.user_id||"system",username:o.from?.username||null,displayName:o.from?`${o.from.first_name||""} ${o.from.last_name||""}`.trim()||"Unknown":"System",avatarUrl:null,avatarPath:null,bot:o.from?.is_bot||!1},message:null,attachments:null,reaction:null,socialEvent:null,configChange:null,apiCall:a.apiCall||null,raw:e}},PROCESS_MESSAGE=async(e,t,n,a,o)=>{if([C.EVENTS.MESSAGE,C.EVENTS.EDIT,C.EVENTS.DELETE,C.EVENTS.PIN].includes(n)){if(e.message={id:t.message_id?t.message_id.toString():o.message_id||"",text:t.text||t.caption||o.text||"",textFormatted:null,replyTo:null,edited:n===C.EVENTS.EDIT,pinned:n===C.EVENTS.PIN},t.reply_to_message){const n=await FIND_ORIGINAL_MESSAGE(t.reply_to_message.message_id.toString(),a.config.id);e.message.replyTo={messageId:t.reply_to_message.message_id.toString(),universalId:n?n.universalId:null,text:(t.reply_to_message.text||t.reply_to_message.caption||"").substring(0,C.TEXT_LIMIT),author:{id:n&&n.author?.id||t.reply_to_message.from?.id?.toString(),username:n&&n.author?.username||t.reply_to_message.from?.username,displayName:n?n.author?.displayName:t.reply_to_message.from?`${t.reply_to_message.from.first_name||""} ${t.reply_to_message.from.last_name||""}`.trim():"Unknown",avatarUrl:n?n.author?.avatarUrl:null}}}o.newText&&(e.message.text=o.newText)}const r=GET_MEDIA_INFO(t);if(r)try{const n=await DOWNLOAD_FILE(a.bot,r.fileId,r.fileName);e.attachments=[{type:r.type,fileUrl:null,filePath:n,filename:r.fileName,mimeType:r.mimeType,size:null,width:r.width,height:r.height,duration:r.duration,caption:t.caption||null}]}catch(n){console.error(`${C.ERRORS.DOWNLOAD} ${r.fileName}:`,n),e.attachments=[{type:r.type,fileUrl:null,filePath:null,filename:r.fileName,mimeType:r.mimeType,size:null,width:r.width,height:r.height,duration:r.duration,caption:t.caption||null}]}[C.EVENTS.JOIN,C.EVENTS.LEAVE,C.EVENTS.BAN].includes(n)&&(e.socialEvent={action:o.action||n,targetUser:{id:o.targetUserId||"unknown",username:o.targetUsername||null,displayName:o.targetDisplayName||"Unknown"},moderator:null,reason:o.reason||null,duration:null,role:null})},CREATE_UNIVERSAL_MESSAGE=async(e,t,n,a={})=>{const o=e.message||e.edited_message||e.channel_post||e.edited_channel_post||e,r=CREATE_BASE_MESSAGE(e,t,n.config.id,a);return await PROCESS_MESSAGE(r,o,t,n,a),r},PUBLISH_EVENT=async(e,t,n,a={})=>{try{const o=await CREATE_UNIVERSAL_MESSAGE(e,t,n,a);await publisherClient.publish(C.CHANNEL,JSON.stringify(o)),await indexClient.rPush(C.HISTORY_KEY,JSON.stringify(o)),o.message&&await CREATE_MESSAGE_INDEX(o.universalId,o)}catch(e){console.error(`${C.ERRORS.PROCESS} ${t} (${n.config.id}):`,e)}},FIND_TELEGRAM_MESSAGE_BY_UNIVERSAL_ID=async(e,t)=>{try{const n=C.INDEX_UNIVERSAL+e,a=await indexClient.hGetAll(n);if(0===Object.keys(a).length)return null;const o=`${C.INDEX_PLATFORM}${t}:`,r=await indexClient.keys(`${o}*`);for(const t of r){if(await indexClient.get(t)===e){const e=t.replace(o,"");return parseInt(e)}}const i=await indexClient.lLen(C.HISTORY_KEY),s=Math.min(i,C.SEARCH_LIMIT);for(let n=0;n<s;n++){const a=await indexClient.lIndex(C.HISTORY_KEY,-1-n);if(a)try{const n=JSON.parse(a);if(n.universalId===e&&n.platform===C.PLATFORM&&n.adapterId===t)return parseInt(n.message?.id)}catch(e){continue}}return null}catch(e){return console.error("Error finding Telegram message:",e),null}},EXECUTE_API_CALL=async(apiCall,bot)=>{try{if("node-telegram-bot-api"===apiCall.api){const command=apiCall.command;if(command.includes("bot.")){const method=command.replace("bot.",""),fn=eval(`bot.${method}`);if("function"==typeof fn)return await fn}}}catch(e){console.error("Error executing API call:",e)}},SHOULD_SEND_MESSAGE=(e,t,n)=>{const a=`${e.adapterId}:${e.conversation.id}`,o=`${t}:${n}`;if(console.log(`Evaluando envío: ${a} -> ${o}`),a===o)return console.log("  Ignorado: mismo origen y destino"),!1;for(const a of ROUTING_RULES)if(a.isAll){if(a.targets.find((e=>e.adapterId===t&&e.chatId===n&&("in"===e.direction||"inout"===e.direction))))return console.log(`  Permitido por regla ALL: ${a.ruleId}`),!0}else{if(a.targets.find((t=>t.adapterId===e.adapterId&&t.chatId===e.conversation.id&&("out"===t.direction||"inout"===t.direction)))){if(a.targets.find((e=>e.adapterId===t&&e.chatId===n&&("in"===e.direction||"inout"===e.direction))))return console.log(`  Permitido por regla: ${a.ruleId}`),!0}}return console.log("  Rechazado: no hay regla que lo permita"),!1};fs.existsSync(MEDIA_FOLDER)||fs.mkdirSync(MEDIA_FOLDER,{recursive:!0});const SEND_METHODS={[C.MEDIA.IMAGE]:(e,t,n,a)=>e.sendPhoto(t,n,a),[C.MEDIA.VIDEO]:(e,t,n,a)=>e.sendVideo(t,n,a),[C.MEDIA.VIDEO_NOTE]:(e,t,n,a)=>e.sendVideoNote(t,n,a),[C.MEDIA.AUDIO]:(e,t,n,a)=>e.sendAudio(t,n,a),[C.MEDIA.VOICE]:(e,t,n,a)=>e.sendVoice(t,n,a),[C.MEDIA.DOCUMENT]:(e,t,n,a)=>e.sendDocument(t,n,a),[C.MEDIA.STICKER]:(e,t,n,a)=>e.sendSticker(t,n,a),[C.MEDIA.GIF]:(e,t,n,a)=>e.sendAnimation(t,n,a)},SEND_UNIVERSAL_MESSAGE_TO_TELEGRAM=async(e,t)=>{try{if(e.apiCall)return void await EXECUTE_API_CALL(e.apiCall,t.bot);const n=[];for(const a of ROUTING_RULES)for(const o of a.targets)if(o.adapterId===t.config.id){SHOULD_SEND_MESSAGE(e,o.adapterId,o.chatId)&&n.push(o)}for(const a of n){const n=a.chatId;let o=null;e.message?.replyTo?.universalId&&(o=await FIND_TELEGRAM_MESSAGE_BY_UNIVERSAL_ID(e.message.replyTo.universalId,t.config.id));const r=e.platform.toUpperCase(),i=e.author.displayName||"Usuario Desconocido",s=e.conversation.name||"";let l=e.message?.text||"";l=`[${r}] ${i} (${s}):\n${l}`;const E={};o&&(E.reply_to_message_id=o);let c=null;try{if(e.attachments&&e.attachments.length>0){const a=e.attachments[0],o=l||a.caption||"";if(a.filePath&&fs.existsSync(a.filePath)){const e=SEND_METHODS[a.type];e&&(a.type===C.MEDIA.VIDEO_NOTE||a.type===C.MEDIA.STICKER?(c=await e(t.bot,n,a.filePath,E),o&&await t.bot.sendMessage(n,o,E)):c=await e(t.bot,n,a.filePath,{...E,caption:o}))}else c=await t.bot.sendMessage(n,`${C.MESSAGES.MEDIA_NOT_FOUND} ${a.filename}\n\n${o}`,E)}else l&&(c=await t.bot.sendMessage(n,l,E));c&&await CREATE_MESSAGE_INDEX(e.universalId,{universalId:e.universalId,platform:C.PLATFORM,adapterId:t.config.id,message:{id:c.message_id.toString()},conversation:{id:n},author:{id:"system"},timestamp:Date.now()})}catch(e){console.error(`Error enviando a ${n} (${t.config.id}): ${e.message}`)}}}catch(e){console.error(`Error procesando mensaje (${t.config.id}):`,e)}},SETUP_GLOBAL_SUBSCRIBER=async e=>{await e.subscribe(C.CHANNEL,(async(e,t)=>{try{const t=JSON.parse(e);for(const e of botInstances)await SEND_UNIVERSAL_MESSAGE_TO_TELEGRAM(t,e)}catch(e){console.error(`${C.ERRORS.SUBSCRIBE}:`,e)}}))},SETUP_EVENT_HANDLERS=e=>{const{bot:t,config:n,info:a}=e;t.on("message",(t=>PUBLISH_EVENT(t,C.EVENTS.MESSAGE,e))),t.on("edited_message",(t=>PUBLISH_EVENT(t,C.EVENTS.EDIT,e,{newText:t.text||t.caption||""}))),t.on("channel_post",(t=>PUBLISH_EVENT(t,C.EVENTS.MESSAGE,e))),t.on("edited_channel_post",(t=>PUBLISH_EVENT(t,C.EVENTS.EDIT,e,{newText:t.text||t.caption||""})));[["inline_query",e=>({text:`Inline query: ${e.query}`,apiCall:{command:"inline_query"}})],["chosen_inline_result",e=>({text:`Chosen inline: ${e.result_id}`,apiCall:{command:"chosen_inline_result"}})],["callback_query",e=>({text:`Callback query: ${e.data||""}`,apiCall:{command:"callback_query"}})],["shipping_query",e=>({text:`Shipping query: ${e.id}`,apiCall:{command:"shipping_query"}})],["pre_checkout_query",e=>({text:`Pre checkout: ${e.total_amount}`,apiCall:{command:"pre_checkout_query"}})],["poll",e=>({text:`Poll: ${e.question}`,apiCall:{command:"poll"}})],["poll_answer",e=>({text:`Poll answer: ${e.option_ids}`,apiCall:{command:"poll_answer"}})]].forEach((([n,a])=>{t.on(n,(t=>PUBLISH_EVENT(t,C.EVENTS.API,e,a(t))))})),t.on("new_chat_members",(t=>{t.new_chat_members.forEach((n=>{PUBLISH_EVENT(t,C.EVENTS.JOIN,e,{text:`Nuevo miembro: ${n.first_name||n.username}`,action:C.EVENTS.JOIN,targetUserId:n.id.toString(),targetUsername:n.username,targetDisplayName:`${n.first_name||""} ${n.last_name||""}`.trim(),reason:"joined"})}))})),t.on("left_chat_member",(t=>{const n=t.left_chat_member;PUBLISH_EVENT(t,C.EVENTS.LEAVE,e,{text:`Miembro salio: ${n.first_name||n.username}`,action:C.EVENTS.LEAVE,targetUserId:n.id.toString(),targetUsername:n.username,targetDisplayName:`${n.first_name||""} ${n.last_name||""}`.trim(),reason:"left"})})),t.on("error",(t=>{console.error(`Bot error (${a.username}):`,t),PUBLISH_EVENT({error:t.message},C.EVENTS.API,e,{text:`Bot error: ${t.message}`,apiCall:{command:"error"}})})),t.on("polling_error",(t=>{console.error(`Polling error (${a.username}):`,t),PUBLISH_EVENT({error:t.message},C.EVENTS.API,e,{text:`Polling error: ${t.message}`,apiCall:{command:"polling_error"}})}))},MAIN=async()=>{await INIT_CLIENTS(),process.on("SIGINT",(async()=>{for(const e of botInstances)await e.bot.close();await publisherClient.quit(),await indexClient.quit(),await subscriberClient.quit(),process.exit(0)}));for(const e of botInstances)await PUBLISH_EVENT({botId:e.info.id},C.EVENTS.API,e,{text:`${e.info.username} conectado`,apiCall:{command:"bot_ready"}});console.log(`Ejecutando (${botInstances.length} instancias)`)};MAIN().catch(console.error);